<div class="row">
  <div class="col">
    <!-- Use Template -->
    <button ep-button ep-colored="primary" ep-theme="ant" class="float-right ml-2" (click)="openUseTemplatePopup()">
      {{ 'EDIT_REQUEST.USE_TEMPLATE' | translate | uppercase }}
    </button>

    <!-- Back -->
    <button ep-button ep-colored="primary" ep-theme="ant" class="float-right" [routerLink]="isNew ? '../' : '../../'">
      {{ 'GENERIC.BTN_BACK' | translate | uppercase }}
    </button>
  </div>
</div>

<!-- Templates modal -->
<app-template-modal [title]="'TEMPLATES.MODAL.TITLE'"
  [isVisible]="isTemplatesModalModalVisible"
  (confirm)="handleTemplatesModalOk($event)" (close)="handleTemplatesModalCancel()">
</app-template-modal>

<hr />

<form nz-form [nzLayout]="'vertical'" [formGroup]="form">

  <div class="row mb-3">
    <div class="col">

      <!-- Main Informations -->
      <ep-accordion epTitle="{{ 'VIEW_REQUEST.MAIN_INFORMATION.HEADER' | translate }}">

        <!-- Row 1 -->
        <div class="row">
          <!-- Title -->
          <div class="col-12 col-xl-6" formGroupName="document">
            <nz-form-item>
              <nz-form-label nzFor="title" nzRequired>{{ 'EDIT_REQUEST.MAIN_INFORMATION.TITLE' | translate }}</nz-form-label>
              <nz-form-control>
                <input id="title" ep-input type="text" formControlName="title" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <!-- Signature Type -->
          <div class="col-12 col-xl-6">
            <nz-form-item>
              <nz-form-label nzRequired class="d-inline-block">{{ 'EDIT_REQUEST.MAIN_INFORMATION.SIGNATURE_TYPE' | translate }}
                <i nz-icon nzType="info-circle" nzTheme="outline" class="form-field-info-icon" *ngIf="selectedSignatureType"
                  nz-popover nzPopoverTitle="Title"
                   (nzVisibleChange)="signatureTypeInfoPopupVisible = !signatureTypeInfoPopupVisible"
                  nzTrigger="click" [nzContent]="contentTemplateSignatureType">
                </i>
              </nz-form-label>

              <!-- Signature Type Info Popup -->
              <ng-template #contentTemplateSignatureType>
                <app-signature-type-info [signatureType]="selectedSignatureType" *ngIf="signatureTypeInfoPopupVisible"></app-signature-type-info>
              </ng-template>

              <nz-form-control>
                <ep-select #signatureType formControlName="signatureType" (ngModelChange)="onSelectSignatureType($event)"
                  epPlaceHolder="{{ 'EDIT_TEMPLATE.MAIN_INFORMATION.SIGNATURE_TYPE.PLACEHOLDER' | translate }}">
                  <ep-option *ngFor="let signatureType of signatureTypes" [epLabel]="signatureType.content.name"
                    [epValue]="signatureType.content.name">
                  </ep-option>
                </ep-select>
              </nz-form-control>
            </nz-form-item>
          </div>

        </div>

         <!-- Row 2 -->

         <div class="row">
          <!-- Open Request -->
          <div class="col-12 col-xl-6">
            <nz-form-item>
              <nz-form-label nzFor="open">{{ 'EDIT_REQUEST.MAIN_INFORMATION.OPEN' | translate }}
                <i nz-icon nzType="info-circle" nzTheme="outline" class="form-field-info-icon"
                  (nzVisibleChange)="openRequestInfoPopupVisible = !openRequestInfoPopupVisible"
                  (click)="openRequestModalHandler()">
                </i>
              </nz-form-label>

              <!-- Open Request Info Popup -->
              <ng-template #contentOpenRequest>
                <div *ngIf="openRequestInfoPopupVisible">
                  {{ 'EDIT_REQUEST.OPEN_REQUEST.POPUP.DESCRIPTION' | translate }}
                </div>
              </ng-template>

              <nz-form-control>
                <input type="checkbox" *epSwitch="{ type:'rounded', size: 'md' }" formControlName="open"
                  [appDisableControl]="selectedSignatureType?.workflowType === WorkflowTypes.SEQUENTIAL">
              </nz-form-control>
            </nz-form-item>
          </div>

          <!-- File -->
          <div class="col-12 col-xl-6">
            <!-- File input -->
            <nz-form-item>
              <nz-form-label nzFor="fileInput" nzRequired>{{ 'EDIT_REQUEST.MAIN_INFORMATION.FILE' | translate }}</nz-form-label>
              <nz-form-control>

                <input #fileInput id="fileInput" type="file" class="w-100"
                  (change)="onFileChange($event)" accept=".doc,.docx,.rtf,.pdf,.jpg,.jpeg" />

              </nz-form-control>
            </nz-form-item>

          </div>

        </div>

        <!-- Row 3 only Edit -->
        <div class="row" *ngIf="!isNew">
          <div class="col-12 col-xl-6"></div>
          <!-- Existing filename -->
          <div class="col-12 col-xl-6">
            <nz-form-item>
              <nz-form-label>{{ 'EDIT_REQUEST.MAIN_INFORMATION.EXISTING_FILE' | translate }}</nz-form-label>
              <nz-form-control>
                <span>{{ existingFileName ? existingFileName : form.value.document.filename }}</span>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <!-- Row 3 only New -->

        <div class="row" *ngIf="isNew">
          <!-- Create & Send(automatically after creation) -->
          <div class="col-12 col-xl-6">
            <nz-form-item>
              <nz-form-label nzFor="open">{{ 'NEW_REQUEST.SEND_REQUEST.LABEL' | translate }}</nz-form-label>
              <nz-form-control>
                <input type="checkbox" *epSwitch="{ type:'rounded', size: 'md' }" formControlName="sendRequest"
                  [appDisableControl]="selectedSignatureType?.keyType?.name === 'Flexible'">
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <!-- Row 5 -->
        <div class="row mb-3 deadline-divider">

          <div class="col-12">
            <nz-divider nzText="{{ 'SEARCH_REQUESTS.CRITERIA.DEADLINE' | translate }}" nzOrientation="left"
                class="text-info"></nz-divider>
          </div>

          <!-- Date Deadline -->
          <div class="col-12 col-xl-6">
            <nz-form-item>
              <nz-form-label nzFor="deadline"
                [nzRequired]="selectedSignatureType?.deadlineType === DeadlineType.DEADLINE_TYPE_FLEXIBLE_MANDATORY || selectedSignatureType?.deadlineType === DeadlineType.DEADLINE_TYPE_STRONG_MANDATORY">
                {{ 'EDIT_REQUEST.MAIN_INFORMATION.DATE_DEADLINE' | translate }}
              </nz-form-label>
              <nz-date-picker formControlName="deadline" [nzFormat]="'dd/MM/yyyy'"
                [nzDisabledDate]="disablePastDates" (ngModelChange)="onChangeDeadlineDate()">
              </nz-date-picker>
            </nz-form-item>
          </div>

          <!-- Time Deadline -->
          <div class="col-12 col-xl-6">
            <nz-form-item>
              <nz-form-label nzFor="deadlineTime">{{ 'EDIT_REQUEST.MAIN_INFORMATION.TIME_DEADLINE' | translate }}</nz-form-label>
              <nz-form-control>
                <nz-time-picker [(ngModel)]="deadlineTime" nzFormat="HH:mm" [ngModelOptions]="{standalone: true}"></nz-time-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

      </ep-accordion>
    </div>
  </div>
</form>

<!-- Signatories -->
<div class="row mb-3">
  <div class="col-12">
    <ep-accordion epTitle="{{ 'EDIT_REQUEST.SIGNATORIES.HEADER' | translate }}">

        <app-persons-editable-list [persons]="signatories" (personsChanged)="updatePersons('signatories', $event)" *ngIf="form.get('open')"
          [hasDeadline]="true" [isSortable]="true" [formLabel]="'EDIT_REQUEST.SIGNATORIES.HEADER'" [isRequired]="!form.get('open').value">
        </app-persons-editable-list>

    </ep-accordion>
  </div>
</div>

<!-- Security and Roles -->
<div class="row mb-3">
  <div class="col-12">
    <ep-accordion epTitle="{{ 'VIEW_REQUEST.SECURITY_ROLES.HEADER' | translate }}">

      <app-persons-editable-list [persons]="securityAndRoles" (personsChanged)="updatePersons('securityAndRoles', $event)"
        [roles]="securityRoles" [formLabel]="'VIEW_REQUEST.SECURITY_ROLES.HEADER'">
      </app-persons-editable-list>

    </ep-accordion>
  </div>
</div>

<!-- Metadata -->
<div class="row mb-5">
  <div class="col">
    <ep-accordion epTitle="{{ 'VIEW_REQUEST.METADATA.HEADER' | translate }}">

    <nz-table #editRowTable nzBordered [nzData]="metadata" [nzShowPagination]="false">
      <thead>
        <tr>
          <th>{{ 'VIEW_REQUEST.METADATA.TABLE.HEADER.METATYPE' | translate }}</th>
          <th>{{ 'VIEW_REQUEST.METADATA.TABLE.HEADER.VALUE' | translate }}</th>
          <th>{{ 'NEW_TEMPLATE.METADATA.ACTION' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of editRowTable.data" class="editable-row">
          <!-- Metadatatype-->
          <td attr.data-label="{{ 'VIEW_REQUEST.METADATA.TABLE.HEADER.METATYPE' | translate }}">
            <ng-container *ngIf="!editMetadataCache[data.id].edit; else metatypeInputTpl">
              {{ data?.metatype?.name }}
            </ng-container>
            <ng-template #metatypeInputTpl>
              <app-metatype-autocomplete
                [inputValue]="editMetadataCache[data.id].data.metatype.name"
                (selectionChange)="editMetadataCache[data.id].data.metatype.name = $event.label"
                (clear)="editMetadataCache[data.id].data.metatype.name = ''">
            </app-metatype-autocomplete>
            </ng-template>
          </td>

          <!-- Value -->
          <td attr.data-label="{{ 'VIEW_REQUEST.METADATA.TABLE.HEADER.VALUE' | translate }}">
            <ng-container *ngIf="!editMetadataCache[data.id].edit; else valueInputTpl">
              {{ data?.value }}
            </ng-container>
            <ng-template #valueInputTpl>
              <input type="text" nz-input [(ngModel)]="editMetadataCache[data.id].data.value" />
            </ng-template>
          </td>

          <td>
            <div class="editable-row-operations">
              <ng-container *ngIf="!editMetadataCache[data.id].edit; else saveTpl">
                <!-- Edit -->
                <button nz-button nzType="secondary" class="mr-2" (click)="startEdit(data.id)">
                  {{ 'NEW_TEMPLATE.METADATA.EDIT' | translate }}
                </button>
                <!-- Delete-->
                <button nz-button nzType="secondary" (click)="deleteEdit(data.id)">
                  {{ 'NEW_TEMPLATE.METADATA.DELETE' | translate }}
                </button>
              </ng-container>
              <!-- Save and Cancel -->
              <ng-template #saveTpl>
                <button nz-button nzType="secondary" class="mr-2" (click)="saveEdit(data.id)">
                  {{ 'NEW_TEMPLATE.METADATA.SAVE' | translate }}
                </button>
                <button nz-button nzType="secondary" (click)="cancelEdit(data.id)">
                  {{ 'NEW_TEMPLATE.METADATA.CANCEL' | translate }}
                </button>
              </ng-template>
            </div>
          </td>
        </tr>
      </tbody>
    </nz-table>

    <button nz-button (click)="addRow()" nzType="primary" class="mt-2 mb-3 float-right">
      {{ 'NEW_TEMPLATE.METADATA.ADD' | translate }}
    </button>

    </ep-accordion>
  </div>

</div>

<div class="floating-btns-container">
  <!-- Save button -->
  <button ep-button ep-theme="ant" ep-colored="primary" type="button"
    class="save-btn" (click)="onSaveHandler()" [disabled]="!form.valid">
    <i nz-icon nzType="save" nzTheme="outline" class="mr-2"></i>
    {{ (isNew ? 'NEW_REQUEST.BTN_SAVE' : 'EDIT_REQUEST.BTN_SAVE') | translate | uppercase }}
  </button>

  <!-- Cancel button -->
  <button ep-button ep-theme="ant" type="button"
    *ngIf="hasChanges" class="cancel-btn ml-3" (click)="onCancel()">
    {{ 'EDIT_TEMPLATE.BTN_CANCEL' | translate | uppercase }}
  </button>
</div>
